<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>G·ª≠i Podcast Ch·ªØa L√†nh T√¢n Sinh Vi√™n</title>
  <style>
    body {
      margin: 0; padding: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #b3d336 0%, #d2ff52 100%);
      position: relative;
      font-family: Arial, sans-serif;
    }
    .pattern { position: fixed; inset: 0; pointer-events: none; z-index: 0;}
    .pattern span { position: absolute; width: 60px; height: 60px; background: pink; border-radius: 50% 40% 60% 50%/50% 60% 40% 50%; opacity: 0.25; animation: float 12s infinite linear;}
    .pattern .c1 { left: 10vw; top: 10vh; }
    .pattern .c2 { left: 60vw; top: 30vh; animation-delay: 2s;}
    .pattern .c3 { left: 30vw; top: 60vh; animation-delay: 4s;}
    .pattern .c4 { left: 70vw; top: 80vh; animation-delay: 6s;}
    @keyframes float { to { transform: translateY(-40px) scale(1.2);}}
    .form-box {
      z-index: 1;
      position: relative;
      background: rgba(255,255,255,0.85);
      border-radius: 15px;
      max-width: 420px; margin: 70px auto; padding: 32px 24px;
      box-shadow: 0 8px 24px #abbf0e33;
    }
    h1 { color: #ee57b0; text-align: center;}
    label { display: block; margin: 14px 0 6px; font-weight: bold;}
    input[type=file], input[type=text] { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #b3d336; color: #333; background: #f8fff0;}
    textarea { width: 100%; border-radius: 5px; min-height: 60px; padding: 8px; border: 1px solid #b3d336; background: #f8fff0;}
    button { margin-top: 15px; display: block; width: 100%; background: #ee57b0; color: white; border: none; border-radius: 7px; font-size: 1.1em; padding: 10px; cursor: pointer; transition: background 0.2s;}
    button:hover { background: #b5158c; }
    .note { color: #1a3500; font-size: .94em;}
    .ttsbox { background:#fafbf1; border:1.5px solid #b4cc73; border-radius:12px; padding:18px 11px 12px 11px; margin:10px 0 20px 0;}
    .ttsbox label {font-weight:bold;}
    .ttsbox textarea {margin-top:4px;}
    .ttsgenbtn { background:#8fd62c; color:white; border:none; border-radius:8px; margin-top:8px; width:auto; display:inline-block; font-size:1em; padding:6px 20px;}
    .ttsgenbtn:hover { background:#60b015;}
    .ttsplay {margin-left:10px;}
    .aipreview audio {margin-top: 6px;}
    .aipreview {color: #92626c; font-size:.97em;}
    .orbox {margin:12px 0 12px 0; text-align:center; color:#914e81; font-size:1.1em; font-weight:bold;}
    .msg {margin-top:7px; color: #34623f; font-size: 1em;}
  </style>
</head>
<body>
  <div class="pattern">
    <span class="c1"></span>
    <span class="c2"></span>
    <span class="c3"></span>
    <span class="c4"></span>
  </div>
  <form class="form-box" id="podcastForm">
    <h1>ü™¥ G·ª≠i Podcast 3 ph√∫t ch·ªØa l√†nh</h1>
    <!-- TTS AI BOX -->
    <div class="ttsbox">
      <label>AI ƒë·ªçc thay b·∫°n (Text-to-Speech):</label>
      <textarea id="aiText" maxlength="350" placeholder="Nh·∫≠p n·ªôi dung mu·ªën AI ƒë·ªçc l√™n ti·∫øng Vi·ªát..."></textarea>
      <button type="button" class="ttsgenbtn" onclick="generateAI()">Chuy·ªÉn vƒÉn b·∫£n th√†nh √¢m thanh</button>
      <button type="button" class="ttsgenbtn ttsplay" onclick="playAI()">üîä Nghe th·ª≠</button>
      <div class="aipreview" id="aiprev"></div>
    </div>
    <div class="orbox">Ho·∫∑c t·ª± g·ª≠i file&nbsp;üé§</div>
    <label>Ch·ªçn file √¢m thanh (mp3, wav, m4a) <span style="color:red">*</span></label>
    <input type="file" accept="audio/*" id="audio"/>
    <p class="note">Ch·ªâ nh·∫≠n file √¢m thanh, t·ªëi ƒëa 3 ph√∫t!</p>
    <label>Ch√∫ th√≠ch file √¢m thanh <span style="color:red">*</span></label>
    <textarea id="desc" maxlength="200" required placeholder="G√µ ch√∫ th√≠ch nh·∫π nh√†ng..."></textarea>
    <button type="submit">G·ª≠i Podcast ‚ú®</button>
    <div class="msg" id="msg"></div>
  </form>
  <script>
    // ------ TTS AI chuy·ªÉn vƒÉn b·∫£n sang mp3 base64
    let lastBlobAI = null;
    function generateAI() {
      const text = document.getElementById('aiText').value.trim();
      const aiprev = document.getElementById('aiprev');
      lastBlobAI = null;
      aiprev.innerHTML = '';
      if (!text) {
        aiprev.innerHTML = 'B·∫°n c·∫ßn nh·∫≠p n·ªôi dung ƒë·ªÉ AI ƒë·ªçc!';
        return;
      }
      aiprev.innerHTML = "ƒêang t·∫°o file AI ƒë·ªçc...";
      // S·ª≠ d·ª•ng SpeechSynthesisUtterance v√† ghi th√†nh file b·∫±ng MediaRecorder
      let synth = window.speechSynthesis;
      let utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'vi-VN';

      // t√¨m voice ti·∫øng Vi·ªát (n·∫øu c√≥)
      let voices = synth.getVoices();
      let viVoice = voices.find(v=>v.lang && v.lang.startsWith('vi'));
      if(viVoice) utter.voice = viVoice;

      // t·∫°o audio v√† mediaRecorder
      const audio = document.createElement('audio');
      audio.controls = true;
      window.recStream && window.recStream.getTracks().forEach(t=>t.stop());

      // S·ª≠ d·ª•ng AudioContext ƒë·ªÉ ghi l·∫°i
      let context = new (window.AudioContext || window.webkitAudioContext)();
      let dest = context.createMediaStreamDestination();
      let recorder = new MediaRecorder(dest.stream);
      let chunks = [];
      utter.onstart = function(){
        aiprev.innerHTML = "AI ƒëang ƒë·ªçc...";
      };
      recorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data);}
      recorder.onstop = function(){
        let blob = new Blob(chunks, {type:'audio/webm'});
        lastBlobAI = blob;
        const url = URL.createObjectURL(blob);
        audio.src = url;
        aiprev.innerHTML = "<b>File √¢m thanh AI ƒë·ªçc:</b><br>";
        aiprev.appendChild(audio);
      };
      // connect TTS to destination
      let source = context.createMediaStreamSource(dest.stream);
      utter.onend = function(){
        recorder.stop();
        context.close();
      };
      // synth.speak kh√¥ng connect ƒëc context, ta d√πng hack b·∫±ng SpeechSynthesisUtterance v√† capture output h·ªá th·ªëng n·∫øu ƒë∆∞·ª£c
      window.speechSynthesis.speak(utter);
      recorder.start();
      setTimeout(()=>{ if(recorder.state=="recording") recorder.stop(); },14000); // auto stop n·∫øu l·ªói
    }

    function playAI() {
      const text = document.getElementById('aiText').value.trim();
      if(!text) return alert("B·∫°n c·∫ßn nh·∫≠p vƒÉn b·∫£n!");
      let utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'vi-VN';
      let voices = window.speechSynthesis.getVoices();
      let viVoice = voices.find(v=>v.lang && v.lang.startsWith('vi'));
      if(viVoice) utter.voice = viVoice;
      speechSynthesis.speak(utter);
    }

    // Khi submit g·ª≠i podcast
    const form = document.getElementById('podcastForm');
    form.onsubmit = function(e){
      e.preventDefault();
      const msg = document.getElementById("msg");
      msg.textContent = "";
      let fileInput = document.getElementById('audio');
      let desc = document.getElementById('desc').value.trim();
      let file = fileInput.files[0];
      // N·∫øu ƒë√£ c√≥ audio AI (lastBlobAI), ∆∞u ti√™n d√πng n√≥
      if(lastBlobAI){
        let reader = new FileReader();
        reader.onload = function(ev){
          let podcasts = JSON.parse(localStorage.getItem("podcasts")||"[]");
          let id = "p_" + Date.now();
          podcasts.push({
            id, desc, audio: ev.target.result, approved: false, created: new Date().toISOString()
          });
          localStorage.setItem("podcasts", JSON.stringify(podcasts));
          lastBlobAI = null;
          document.getElementById('aiText').value = '';
          document.getElementById('desc').value = '';
          document.getElementById('aiprev').innerHTML = '';
          msg.textContent = "ƒê√£ g·ª≠i file AI ƒë·ªçc! Ch·ªù ki·ªÉm duy·ªát.";
        };
        reader.readAsDataURL(lastBlobAI);
        return;
      }
      if(!file) return msg.textContent = "B·∫°n c·∫ßn ch·ªçn file √¢m thanh ho·∫∑c d√πng AI ƒë·ªçc!";
      if (!file.type.startsWith('audio')) return msg.textContent = "Ch·ªâ ch·∫•p nh·∫≠n file √¢m thanh!";
      // Check 3 ph√∫t
      let url = URL.createObjectURL(file);
      let audio = document.createElement('audio');
      audio.src = url;
      audio.onloadedmetadata = function(){
        if(audio.duration > 181) { msg.textContent = "File v∆∞·ª£t qu√° 3 ph√∫t!"; return;}
        let podcasts = JSON.parse(localStorage.getItem("podcasts")||"[]");
        let id = "p_" + Date.now();
        let reader = new FileReader();
        reader.onload = function(ev) {
          podcasts.push({
            id, desc, audio: ev.target.result, approved: false, created: new Date().toISOString()
          });
          localStorage.setItem("podcasts", JSON.stringify(podcasts));
          fileInput.value = '';
          document.getElementById('desc').value = '';
          msg.textContent = "ƒê√£ g·ª≠i! Ch·ªù ki·ªÉm duy·ªát.";
        };
        reader.readAsDataURL(file);
      };
      audio.onerror = ()=>msg.textContent="Kh√¥ng th·ªÉ ƒë·ªçc file √¢m thanh!";
    };
  </script>
</body>
</html>